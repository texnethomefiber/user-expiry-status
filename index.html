<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    .Expired { background: #ffd2d2; }
    .Expiring { background: #fffacc; }
    .Active { background: #d2ffd2; }
    .Unknown { background: #e0e0e0; }
    input[type="text"], select { width: 100%; padding: 8px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>User Dashboard</h1>
  <input type="text" id="search" placeholder="Search users..." />
  <select id="statusFilter">
    <option value="">All Statuses</option>
    <option value="Active">Active</option>
    <option value="Expiring">Expiring</option>
    <option value="Expired">Expired</option>
    <option value="Unknown">Unknown</option>
  </select>
  <select id="locationFilter">
    <option value="">All Locations</option>
  </select>
  <table id="userTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Amount</th>
        <th>Location</th>
        <th>Payment Date</th>
        <th>Expiry Date</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=0&single=true&output=csv";

    function getStatus(expiryRaw) {
      if (!expiryRaw) return "Unknown";
      const expiry = expiryRaw.trim().replace(/[\r\n"]+/g, "");
      const match = expiry.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (!match) return "Unknown";
      const [ , day, month, year, hour, minute, second = "00" ] = match;
      const isoDateStr = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
      const expDate = new Date(isoDateStr);
      if (isNaN(expDate)) return "Unknown";
      const now = new Date();
      const diff = expDate - now;
      if (diff < 0) return "Expired";
      if (diff <= 86400000) return "Expiring";
      return "Active";
    }

    function fetchAndDisplayUsers() {
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          let users = results.data;
          const table = document.querySelector("#userTable tbody");
          table.innerHTML = "";

          const locationsSet = new Set();

          users = users.sort((a, b) => {
            const aDateStr = a["Expiry Date"] || a["expiry date"] || a["expiry"] || "";
            const bDateStr = b["Expiry Date"] || b["expiry date"] || b["expiry"] || "";

            const aMatch = aDateStr.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
            const bMatch = bDateStr.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
            if (!aMatch || !bMatch) return 0;

            const aIso = `${aMatch[3]}-${aMatch[2]}-${aMatch[1]}T${aMatch[4]}:${aMatch[5]}:${aMatch[6] || "00"}`;
            const bIso = `${bMatch[3]}-${bMatch[2]}-${bMatch[1]}T${bMatch[4]}:${bMatch[5]}:${bMatch[6] || "00"}`;

            return new Date(aIso) - new Date(bIso); // ascending order
          });

          users.forEach(user => {
            const expiry = user["Expiry Date"] || user["expiry date"] || user["expiry"] || "";
            const status = getStatus(expiry);
            const location = user["Location"] || user["location"] || "";
            locationsSet.add(location);

            const row = document.createElement("tr");
            row.className = status;
            row.setAttribute("data-status", status);
            row.setAttribute("data-location", location.toLowerCase());
            row.innerHTML = `
              <td>${user["Name"] || user["name"] || ""}</td>
              <td>${user["Phone"] || user["phone"] || ""}</td>
              <td>${user["Amount"] || user["amount"] || ""}</td>
              <td>${location}</td>
              <td>${user["Payment Date"] || user["payment date"] || ""}</td>
              <td>${expiry}</td>
              <td>${status}</td>
            `;
            table.appendChild(row);
          });

          const locationFilter = document.getElementById("locationFilter");
          locationFilter.innerHTML = '<option value="">All Locations</option>';
          locationsSet.forEach(loc => {
            if (loc.trim()) {
              const option = document.createElement("option");
              option.value = loc;
              option.textContent = loc;
              locationFilter.appendChild(option);
            }
          });
        }
      });
    }

    function applyFilters() {
      const searchFilter = document.getElementById("search").value.toLowerCase();
      const statusFilter = document.getElementById("statusFilter").value;
      const locationFilter = document.getElementById("locationFilter").value;
      const rows = document.querySelectorAll("#userTable tbody tr");

      rows.forEach(row => {
        const textMatch = row.innerText.toLowerCase().includes(searchFilter);
        const statusMatch = !statusFilter || row.getAttribute("data-status") === statusFilter;
        const locationMatch = !locationFilter || row.getAttribute("data-location") === locationFilter.toLowerCase();
        row.style.display = (textMatch && statusMatch && locationMatch) ? "" : "none";
      });
    }

    document.getElementById("search").addEventListener("input", applyFilters);
    document.getElementById("statusFilter").addEventListener("change", applyFilters);
    document.getElementById("locationFilter").addEventListener("change", applyFilters);

    fetchAndDisplayUsers();
  </script>
</body>
</html>
