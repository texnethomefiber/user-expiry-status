<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    h1 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    .Expired { background: #ffd2d2; }
    .Expiring { background: #fffacc; }
    .Active { background: #d2ffd2; }
    .Unknown { background: #e0e0e0; }
    input[type="text"] { width: 100%; padding: 8px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>User Dashboard</h1>
  <input type="text" id="search" placeholder="Search users..." />
  <table id="userTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Status</th>
        <th>Amount</th>
        <th>Location</th>
        <th>Payment Date</th>
        <th>Expiry Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=0&single=true&output=csv";

    function getStatus(expiryRaw) {
      if (!expiryRaw) return "Unknown";
      const expiry = expiryRaw.trim().replace(/[
"]+/g, "");

      // Expected format: DD/MM/YYYY HH:MM:SS
      const match = expiry.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?/);
      if (!match) return "Unknown";

      const [ , day, month, year, hour, minute, second = "00" ] = match;
      const isoDateStr = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
      const expDate = new Date(isoDateStr);

      if (isNaN(expDate)) return "Unknown";

      const now = new Date();
      const diff = expDate - now;
      if (diff < 0) return "Expired";
      if (diff <= 86400000) return "Expiring";
      return "Active";
    }

    function fetchAndDisplayUsers() {
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          const users = results.data;
          const table = document.querySelector("#userTable tbody");
          table.innerHTML = "";

          users.forEach(user => {
            const expiry = user["Expiry Date"] || user["expiry date"] || user["expiry"] || "";
            const status = getStatus(expiry);

            const row = document.createElement("tr");
            row.className = status;
            row.innerHTML = `
              <td>${user["Name"] || user["name"] || ""}</td>
              <td>${user["Phone"] || user["phone"] || ""}</td>
              <td>${status}</td>
              <td>${user["Amount"] || user["amount"] || ""}</td>
              <td>${user["Location"] || user["location"] || ""}</td>
              <td>${user["Payment Date"] || user["payment date"] || ""}</td>
              <td>${expiry}</td>
            `;
            table.appendChild(row);
          });
        }
      });
    }

    document.getElementById("search").addEventListener("input", function(e) {
      const filter = e.target.value.toLowerCase();
      const rows = document.querySelectorAll("#userTable tbody tr");
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
      });
    });

    fetchAndDisplayUsers();
  </script>
</body>
</html>
