<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    th span {
      margin-left: 5px;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    input, select {
      margin-bottom: 10px;
      padding: 5px;
    }
  </style>
</head>
<body>

<h2>User Dashboard</h2>
<input type="text" id="searchInput" placeholder="Search users...">
<select id="filterStatus">
  <option value="">All Status</option>
  <option value="Active">Active</option>
  <option value="Expired">Expired</option>
  <option value="Expiring Soon">Expiring Soon</option>
</select>
<select id="filterLocation">
  <option value="">All Locations</option>
</select>

<table id="userTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Phone</th>
      <th>Amount</th>
      <th>Location</th>
      <th id="sort-payment" data-sort="asc">Payment Date <span id="icon-payment">↑</span></th>
      <th id="sort-expiry" data-sort="asc">Expiry Date <span id="icon-expiry"></span></th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=0&single=true&output=csv';

  function parseDate(dateStr) {
    const [day, month, yearAndTime] = dateStr.split("/");
    const [year, time] = yearAndTime.split(" ");
    const [hours, minutes, seconds] = time.split(":");
    return new Date(`${year}-${month}-${day}T${hours}:${minutes}:${seconds}`);
  }

  function determineStatus(expiryDateStr) {
    const expiry = parseDate(expiryDateStr);
    const now = new Date();
    const diff = expiry - now;
    if (isNaN(expiry)) return 'Unknown';
    if (diff < 0) return 'Expired';
    if (diff <= 24 * 60 * 60 * 1000) return 'Expiring Soon';
    return 'Active';
  }

  function populateTable(data) {
    const tbody = document.querySelector("#userTable tbody");
    tbody.innerHTML = "";
    const locations = new Set();

    data.forEach(row => {
      const tr = document.createElement("tr");
      const status = determineStatus(row[6]);
      locations.add(row[4]);

      tr.innerHTML = `
        <td>${row[0]}</td>
        <td>${row[1]}</td>
        <td>${row[2]}</td>
        <td>${row[4]}</td>
        <td>${row[5]}</td>
        <td>${row[6]}</td>
        <td>${status}</td>
      `;
      tbody.appendChild(tr);
    });

    // Populate location filter
    const filterLocation = document.getElementById("filterLocation");
    locations.forEach(loc => {
      if (![...filterLocation.options].some(o => o.value === loc)) {
        const opt = document.createElement("option");
        opt.value = opt.textContent = loc;
        filterLocation.appendChild(opt);
      }
    });
  }

  function filterTable() {
    const search = document.getElementById("searchInput").value.toLowerCase();
    const statusFilter = document.getElementById("filterStatus").value;
    const locationFilter = document.getElementById("filterLocation").value;
    const rows = document.querySelectorAll("#userTable tbody tr");

    rows.forEach(row => {
      const name = row.cells[0].textContent.toLowerCase();
      const status = row.cells[6].textContent;
      const location = row.cells[3].textContent;
      const match = name.includes(search) &&
                    (!statusFilter || status === statusFilter) &&
                    (!locationFilter || location === locationFilter);
      row.style.display = match ? "" : "none";
    });
  }

  function sortTableByDate(table, colIndex, direction) {
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    rows.sort((a, b) => {
      const aDate = parseDate(a.cells[colIndex].textContent);
      const bDate = parseDate(b.cells[colIndex].textContent);
      return direction === "asc" ? aDate - bDate : bDate - aDate;
    });
    rows.forEach(row => table.querySelector("tbody").appendChild(row));
  }

  function updateSortIcons(activeColumn, direction) {
    document.getElementById("icon-payment").textContent = activeColumn === "payment" ? (direction === "asc" ? "↑" : "↓") : "";
    document.getElementById("icon-expiry").textContent = activeColumn === "expiry" ? (direction === "asc" ? "↑" : "↓") : "";
  }

  document.getElementById("sort-payment").addEventListener("click", () => {
    const header = document.getElementById("sort-payment");
    const direction = header.getAttribute("data-sort") === "asc" ? "desc" : "asc";
    header.setAttribute("data-sort", direction);
    sortTableByDate(document.getElementById("userTable"), 4, direction);
    updateSortIcons("payment", direction);
  });

  document.getElementById("sort-expiry").addEventListener("click", () => {
    const header = document.getElementById("sort-expiry");
    const direction = header.getAttribute("data-sort") === "asc" ? "desc" : "asc";
    header.setAttribute("data-sort", direction);
    sortTableByDate(document.getElementById("userTable"), 5, direction);
    updateSortIcons("expiry", direction);
  });

  document.getElementById("searchInput").addEventListener("input", filterTable);
  document.getElementById("filterStatus").addEventListener("change", filterTable);
  document.getElementById("filterLocation").addEventListener("change", filterTable);

  fetch(sheetURL)
    .then(res => res.text())
    .then(csv => {
      const rows = csv.trim().split("\n").slice(1).map(line => line.split(","));
      populateTable(rows);
      sortTableByDate(document.getElementById("userTable"), 4, "asc");
    });
</script>
</body>
</html>
