<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h2 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: left; }
    th { cursor: pointer; background: #eee; }
    tr:nth-child(even) { background: #f2f2f2; }
    .expired { background: #ffe6e6; }
    .expiring { background: #fff7cc; }
    .active { background: #e6ffe6; }
    #summary { margin-top: 20px; }
    #filterInput { padding: 8px; width: 250px; margin-bottom: 10px; }
    #exportBtn { padding: 8px 12px; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>User Dashboard</h2>
  <input type="text" id="filterInput" placeholder="Search users...">
  <button id="exportBtn">Export Filtered View</button>
  <div id="summary"></div>
  <table id="userTable"></table>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQvwH72sBpfyaBheSCdEdnlqq3b7l4YMzA_-6-k06624D2yc3ko0vUVgh5taJzyPsqFN9kqWNVgMQk/pub?gid=0&single=true&output=csv';

    function parseAmount(str) {
      if (!str) return 0;
      return parseFloat(str.replace(/[A-Za-zKsh\s,\"]+/g, '').trim()) || 0;
    }

    function isValidDate(d) {
      return d instanceof Date && !isNaN(d);
    }

    function loadCSV() {
      fetch(sheetUrl)
        .then(res => res.text())
        .then(csv => {
          Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              displayUsers(results.data);
            }
          });
        });
    }

    function displayUsers(data) {
      const table = document.getElementById('userTable');
      const now = new Date();
      const soon = new Date(now.getTime() + 24 * 60 * 60 * 1000);

      let html = '<thead><tr>';
      const keys = Object.keys(data[0]);
      keys.forEach(key => html += `<th>${key}</th>`);
      html += '<th>Status</th></tr></thead><tbody>';

      let totalAmount = 0;
      let userCount = 0;
      let locationMap = {};

      data.forEach(row => {
        const expiryStr = row['Expiry Date'];
        const expiryDate = new Date(expiryStr);
        const amount = parseAmount(row['Amount']);

        let status = 'Active';
        let rowClass = 'active';

        if (!isValidDate(expiryDate)) {
          status = 'Unknown';
        } else if (expiryDate < now) {
          status = 'Expired';
          rowClass = 'expired';
        } else if (expiryDate < soon) {
          status = 'Expiring Soon';
          rowClass = 'expiring';
        }

        if (status !== 'Unknown') {
          userCount++;
          totalAmount += amount;
          const location = row['Location'] || 'Unknown';
          locationMap[location] = locationMap[location] || { count: 0, total: 0 };
          locationMap[location].count++;
          locationMap[location].total += amount;
        }

        html += `<tr class="${rowClass}">`;
        keys.forEach(k => html += `<td>${row[k]}</td>`);
        html += `<td>${status}</td></tr>`;
      });

      html += '</tbody>';
      table.innerHTML = html;

      document.getElementById('summary').innerHTML =
        `<strong>Total Users:</strong> ${userCount} | <strong>Total Amount:</strong> Ksh ${totalAmount.toLocaleString()}<br><br>` +
        Object.entries(locationMap).map(([loc, {count, total}]) =>
          `${loc}: ${count} users â€” Ksh ${total.toLocaleString()}`
        ).join('<br>');

      document.querySelectorAll('th').forEach((th, i) => {
        th.addEventListener('click', () => sortTable(i));
      });
    }

    function sortTable(colIndex) {
      const table = document.getElementById("userTable");
      const rows = Array.from(table.rows).slice(1);
      const dir = table.getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
      table.setAttribute('data-sort-dir', dir);
      rows.sort((a, b) => {
        const x = a.cells[colIndex].textContent.trim();
        const y = b.cells[colIndex].textContent.trim();
        return dir === 'asc' ? x.localeCompare(y) : y.localeCompare(x);
      });
      rows.forEach(r => table.appendChild(r));
    }

    document.getElementById('filterInput').addEventListener('input', function() {
      const val = this.value.toLowerCase();
      const rows = document.querySelectorAll('#userTable tbody tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(val) ? '' : 'none';
      });
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const rows = Array.from(document.querySelectorAll('#userTable tbody tr')).filter(r => r.style.display !== 'none');
      let csv = Array.from(document.querySelectorAll('#userTable thead tr th')).map(th => th.textContent).join(',') + '\n';
      rows.forEach(row => {
        const cells = Array.from(row.cells).map(td => '"' + td.textContent.replace(/"/g, '""') + '"');
        csv += cells.join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'filtered_users.csv';
      link.click();
    });

    loadCSV();
    setInterval(loadCSV, 5 * 60 * 1000);
  </script>
</body>
</html>
